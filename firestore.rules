rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë¬¸ì„œë§Œ ì½ê³  ì“¸ ìˆ˜ ìˆìŒ
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;

      // ğŸ” ì¤‘ìš”: plan, subscription í•„ë“œëŠ” ìˆ˜ì • ê¸ˆì§€ (ê²°ì œ ì„œë²„/ê´€ë¦¬ìë§Œ ë³€ê²½ ê°€ëŠ¥)
      allow update: if request.auth != null &&
                   request.auth.uid == userId &&
                   !('plan' in request.resource.data.diff(resource.data).changedKeys()) &&
                   !('subscription' in request.resource.data.diff(resource.data).changedKeys());
    }
    
    // ì„¸ì…ì ì •ë³´ëŠ” ë³¸ì¸ ê²ƒë§Œ ì ‘ê·¼ ê°€ëŠ¥ (ìµœìƒìœ„ tenants ì»¬ë ‰ì…˜)
    match /tenants/{tenantId} {
      allow read, write: if request.auth != null &&
                        request.auth.uid == resource.data.ownerId;
      allow create: if request.auth != null &&
                   request.auth.uid == request.resource.data.ownerId;
    }

    // ğŸ”¥ ìˆ˜ì •: ì‚¬ìš©ìë³„ ì„ì°¨ì¸ ì„œë¸Œì»¬ë ‰ì…˜ ê·œì¹™ ì¶”ê°€ (ì‹¤ì œ ì €ì¥ ê²½ë¡œ)
    match /users/{userId}/tenants/{tenantId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow list: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ”¥ ìˆ˜ì •: ì‚¬ìš©ìë³„ ê²°ì œ ì„œë¸Œì»¬ë ‰ì…˜ ê·œì¹™ ì¶”ê°€
    match /users/{userId}/payments/{paymentId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow list: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ”¥ ìˆ˜ì •: ì‚¬ìš©ìë³„ íŠ¹ì•½ì‚¬í•­ ì„œë¸Œì»¬ë ‰ì…˜ ê·œì¹™ ì¶”ê°€
    match /users/{userId}/specialTerms/{termId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow list: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ”¥ ì¶”ê°€: ì‚¬ìš©ìë³„ íŠ¹ì•½ì‚¬í•­ (ìµœìƒìœ„, snake_case ë²„ì „)
    match /users/{userId}/special_terms/{termId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ”¥ ì¶”ê°€: ì‚¬ìš©ìë³„ ê³„ì•½ì„œ ì„œë¸Œì»¬ë ‰ì…˜
    match /users/{userId}/contracts/{contractId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ”¥ ì¶”ê°€: ì‚¬ìš©ìë³„ ê²½ë¹„ ì„œë¸Œì»¬ë ‰ì…˜
    match /users/{userId}/expenses/{expenseId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ”¥ ì¶”ê°€: ì‚¬ìš©ìë³„ ë¦¬í¬íŠ¸ ì„œë¸Œì»¬ë ‰ì…˜
    match /users/{userId}/reports/{reportId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ”¥ ì¶”ê°€: ì‚¬ìš©ìë³„ ì„¤ì •
    match /users/{userId}/user_settings/{settingId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ”¥ ì¶”ê°€: ì‚¬ìš©ìë³„ ë¶€ë™ì‚° ìì‚° ì„œë¸Œì»¬ë ‰ì…˜
    match /users/{userId}/property_assets/{assetId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ”¥ ì¶”ê°€: ì‚¬ìš©ìë³„ ì°¨ì…ê¸ˆ(ëŒ€ì¶œ) ì„œë¸Œì»¬ë ‰ì…˜
    match /users/{userId}/loans/{loanId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ”¥ ì¶”ê°€: ì‚¬ìš©ìë³„ ë³´ì¦ê¸ˆ ê±°ë˜ ì„œë¸Œì»¬ë ‰ì…˜
    match /users/{userId}/deposit_transactions/{transactionId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ”¥ ì¶”ê°€: êµ¬ë… ê²°ì œ ë¡œê·¸
    match /subscription_payments/{paymentId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // ğŸ”¥ ì¶”ê°€: ì‚¬ìš©ì êµ¬ë… ì •ë³´
    match /user_subscriptions/{subscriptionId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if request.auth != null &&
                   (request.auth.token.admin == true ||
                    resource.data.userId == request.auth.uid);
    }

    // ğŸ”¥ ì¶”ê°€: í”Œëœ ì´ë ¥
    match /plan_history/{historyId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
    }

    // ğŸ”¥ ì¶”ê°€: ì‚¬ìš©ì í”Œëœ ì •ë³´ (user_plans ì»¬ë ‰ì…˜)
    match /user_plans/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      // ê´€ë¦¬ì ë˜ëŠ” ê²°ì œ ì„œë²„(Admin SDK)ë§Œ ìˆ˜ì • ê°€ëŠ¥
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    // ğŸ”¥ ì¶”ê°€: ì‚¬ìš©ìë³„ êµ¬ë… ì •ë³´ ì„œë¸Œì»¬ë ‰ì…˜
    match /users/{userId}/subscriptions/{subscriptionId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null &&
                  (request.auth.token.admin == true || request.auth.uid == userId);
    }

    // ğŸ”¥ ì¶”ê°€: ì¶”ì²œì¸ ë¡œê·¸ (ë³¸ì¸ ê´€ë ¨ ê¸°ë¡ë§Œ ì½ê¸° ê°€ëŠ¥)
    match /referral_logs/{logId} {
      allow read: if request.auth != null &&
                  (resource.data.referrerId == request.auth.uid ||
                   resource.data.newUserId == request.auth.uid);
      allow create: if request.auth != null;
    }

    // ğŸ”¥ ì¶”ê°€: í¬ì¸íŠ¸ êµ¬ë§¤ ë¡œê·¸ (ë³¸ì¸ ê²ƒë§Œ ì½ê¸°)
    match /point_purchases/{purchaseId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
    }

    // ğŸš« ê´€ë¦¬ìë§Œ ëª¨ë“  ë°ì´í„° ì ‘ê·¼ ê°€ëŠ¥ (ì¼ë°˜ ì‚¬ìš©ìëŠ” ìœ„ì— ëª…ì‹œëœ ê·œì¹™ë§Œ)
    match /{document=**} {
      allow read, write: if request.auth != null && request.auth.token.admin == true;
    }
  }
}