rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë¬¸ì„œë§Œ ì½ê³  ì“¸ ìˆ˜ ìˆìŒ
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // ğŸ” ì¤‘ìš”: plan í•„ë“œëŠ” ìˆ˜ì • ê¸ˆì§€ (ê´€ë¦¬ìê°€ Firebase Consoleì—ì„œë§Œ ë³€ê²½ ê°€ëŠ¥)
      allow update: if request.auth != null && 
                   request.auth.uid == userId &&
                   !('plan' in request.resource.data.diff(resource.data).changedKeys());
    }
    
    // ì„¸ì…ì ì •ë³´ëŠ” ë³¸ì¸ ê²ƒë§Œ ì ‘ê·¼ ê°€ëŠ¥ (ìµœìƒìœ„ tenants ì»¬ë ‰ì…˜)
    match /tenants/{tenantId} {
      allow read, write: if request.auth != null &&
                        request.auth.uid == resource.data.ownerId;
      allow create: if request.auth != null &&
                   request.auth.uid == request.resource.data.ownerId;
    }

    // ğŸ”¥ ìˆ˜ì •: ì‚¬ìš©ìë³„ ì„ì°¨ì¸ ì„œë¸Œì»¬ë ‰ì…˜ ê·œì¹™ ì¶”ê°€ (ì‹¤ì œ ì €ì¥ ê²½ë¡œ)
    match /users/{userId}/tenants/{tenantId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow list: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ”¥ ìˆ˜ì •: ì‚¬ìš©ìë³„ ê²°ì œ ì„œë¸Œì»¬ë ‰ì…˜ ê·œì¹™ ì¶”ê°€
    match /users/{userId}/payments/{paymentId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow list: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ”¥ ìˆ˜ì •: ì‚¬ìš©ìë³„ íŠ¹ì•½ì‚¬í•­ ì„œë¸Œì»¬ë ‰ì…˜ ê·œì¹™ ì¶”ê°€
    match /users/{userId}/specialTerms/{termId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow list: if request.auth != null && request.auth.uid == userId;
    }

    // ğŸ”¥ ì¶”ê°€: ì‚¬ìš©ì í”Œëœ ì •ë³´ (user_plans ì»¬ë ‰ì…˜)
    match /user_plans/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null &&
                  (request.auth.token.admin == true || request.auth.uid == userId);
    }

    // ğŸ”¥ ì¶”ê°€: ì‚¬ìš©ìë³„ êµ¬ë… ì •ë³´ ì„œë¸Œì»¬ë ‰ì…˜
    match /users/{userId}/subscriptions/{subscriptionId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null &&
                  (request.auth.token.admin == true || request.auth.uid == userId);
    }

    // ê¸°íƒ€ ì»¬ë ‰ì…˜ë“¤ì€ ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ìì‹ ì˜ ë°ì´í„° ì ‘ê·¼
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}